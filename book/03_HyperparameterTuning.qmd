---
title: "Script 3 - Hyperparameter Tuning"
author: 
  - name: "MSc. Friederike Johanna Rosa WÃ¶lke"
    orcid: "0000-0001-9034-4883"
    url: "https://friedarosa.github.io"
    email: "wolke@fzp.czu.cz"
    corresponding: true
date: "2023-05-29"
---

::: panel-tabset
## Source custom functions

```{r}
#| label: load-packages
#| message: FALSE
#| warning: FALSE
rm(list = ls())
source("../src/functions.R")

```

## MachineLearning packages

```{r}
#| label: load-ML-packages
#| message: FALSE
#| error: FALSE

pckgs <- c("dplyr", "ggplot2", "reshape2", 
           "caret", "caretEnsemble", 
           "randomForest", "ranger", "gbm", "xgboost", 
           "gridExtra", "kableExtra")


install_and_load(pckgs)
```

## Load RData to reduce computing time

```{r}
#| label: load-RData
#| message: FALSE
#| error: FALSE

# Load workspace to save computing time:
## it has: varPart from ranger models
## recursive feature selection results

# load("data/varPart_rfe.RData")
# load("data/models.RData")
load("../data/RData/01_Data_prep.RData")
```
:::

### Individual models

#### Hyperparameter tuning

```{r}
#| label: hyperparameter-tuning
#| eval: false

index_list <- list(indices_J1, indices_J2, indices_LR1, indices_LR2)
dat_train_list <- list(dat_train_J1, dat_train_J2, dat_train_LR1, dat_train_LR2)

saved_models <- replicate(4, list())
names(saved_models) <- c("J1", "J2", "LR1", "LR2")

reduced_predictors <- list(
  J1 = c()
)

response_list <- c("Jaccard", "Jaccard", "log_R2_1", "log_R2_1")

for(j in seq_along(1:4)){
  ## Loop through differet datasets/Analyses
  indices <- index_list[[j]]
  dat_train <- dat_train_list[[j]]
  response <- response_list[[j]] 
  
  # Define training control ==========================================================
  trainControl <- trainControl(
    method = "repeatedcv",
    number = 10,
    repeats = 3,
    savePredictions = "final",
    returnResamp = "all",
    verboseIter = FALSE,
    index = indices)

  ## Train ranger model ==========================================================
  set.seed(42)
  tictoc::tic("ranger")
  rangerModel_t <- train(
    as.formula(paste(response, "~ .")),
    data = dat_train,
    method = "ranger",
    trControl = trainControl,
    importance = "permutation",
    scale.permutation.importance = TRUE,
    num.trees = 1000,
    respect.unordered.factors = TRUE,
    oob.error = TRUE,
    tuneLength = 20)
  
  saveRDS(rangerModel_t, paste0("../data/rds/rangerModel_", response, j, "all.rds"))
  tictoc::toc()
  
  # rangerModel_t <- readRDS( paste0("../data/rds/rangerModel_", response, j, "all.rds"))

  ### Model results:
  p_rangerModel <- plot(rangerModel_t)
  p_rangerModel
  rangerModel_t$finalModel

  ## Train xgbTree model ==========================================================
  xgb_grid <- expand.grid(
    nrounds = c(1000),
    eta = c(0.1, 0.3),
    max_depth = c(2,3, 5),
    gamma = c(0, 0.01, 0.1),
    colsample_bytree = 0.6,
    min_child_weight = 1,
    subsample =1)
  
  tictoc::tic("xgb")
  set.seed(42)
  xgbModel_t <- train(
    as.formula(paste(response, "~ .")),
    data = dat_train,
    method = "xgbTree",
    trControl = trainControl,
    tuneGrid = xgb_grid)
  saveRDS(xgbModel_t, paste0("../data/rds/xgbModel_all_", response, j, "TLCUSTOM.rds"))
  tictoc::toc()
  
  # xgbModel_t <- readRDS(paste0("../data/rds/xgbModel_all_", response, j, "TLCUSTOM.rds"))

  ### Model results:
  p_xgbModel <- plot(xgbModel_t)
  p_xgbModel
  slice_min(xgbModel_t$results, RMSE)
  slice_max(xgbModel_t$results, Rsquared)

  
  ## Train gbm model ==========================================================
  set.seed(42)
  tictoc::tic("gbm")
  gbmModel_t <- train(
    as.formula(paste(response, "~ .")),
    data = dat_train,
    method = "gbm",
    trControl = trainControl,
    tuneLength= 20,
    verbose = FALSE)
  saveRDS(gbmModel_t, paste0("../data/rds/gbmModel_", response, j, "all.rds"))
  tictoc::toc()

  # gbmModel_t <- readRDS(paste0("../data/rds/gbmModel_", response, j, "all.rds")))


  ### Model results:
  summary.gbm(gbmModel_t$finalModel)
  p_gbmModel <- plot(gbmModel_t)
  p_gbmModel
  gbmModel_t$finalModel
  slice_min(gbmModel_t$results, RMSE)
  slice_max(gbmModel_t$results, Rsquared)
  
  saved_models[[j]] <- list(rangerModel_t, xgbModel_t, gbmModel_t)
}

saveRDS(saved_models, "../data/rds/hyper_para_tuning_all_models.rds")
save.image("../data/RData/hyper_para_tuning.RData")
```

::: panel-tabset
## Jaccard 1

```{r}

# Jaccard 1
rangerM <- readRDS("../data/models/03_rangerModel_Jaccard1all.rds")
xgbM <- readRDS("../data/models/03_xgbModel_all_Jaccard1TLCUSTOM.rds")
gbmM <- readRDS("../data/models/03_gbmModel_Jaccard1all.rds")


rangerM$bestTune
rangerM$finalModel$r.squared
plot(rangerM) 
plot(xgbM)
xgbM

xgbM$finalModel
plot(gbmM)


cbind(
  varImp(rangerM)$importance %>% 
    round(2) %>% 
    mutate(var_ranger = rownames(.)) %>% 
    arrange(desc(Overall)) %>% 
    rename("Imp_ranger" = "Overall"),
  summary.gbm(gbmM$finalModel, plotit=FALSE) %>% 
    mutate_if(is.numeric, round, 2) %>% 
    mutate(var_gbm = rownames(.)) %>% 
    arrange(desc(rel.inf)) %>% 
    rename("Imp_gbm" = "rel.inf"),
  varImp(xgbM)$importance %>% 
    round(2) %>% 
    mutate(var_gbm = rownames(.)) %>% 
    arrange(desc(Overall)) %>% 
    rename("Imp_gbm" = "Overall")
)


```

## Jaccard 2

```{r}
#| eval: false
# Jaccard 2
rangerM <- readRDS("../data/models/03_rangerModel_all_Jaccard2.rds")
xgbM <- readRDS("../data/models/03_xgbModel_all_Jaccard2TLCUSTOM.rds")
gbmM <- readRDS("../data/models/03_gbmModel_Jaccard2all.rds")


rangerM$bestTune
rangerM$finalModel$r.squared
plot(rangerM) 
plot(xgbM)
xgbM

xgbM$finalModel
plot(gbmM)


cbind(
  varImp(rangerM)$importance %>% 
    round(2) %>% 
    mutate(var_ranger = rownames(.)) %>% 
    arrange(desc(Overall)) %>% 
    rename("Imp_ranger" = "Overall"),
  summary.gbm(gbmM$finalModel, plotit=FALSE) %>% 
    mutate_if(is.numeric, round, 2) %>% 
    mutate(var_gbm = rownames(.)) %>% 
    arrange(desc(rel.inf)) %>% 
    rename("Imp_gbm" = "rel.inf"),
  varImp(xgbM)$importance %>% 
    round(2) %>% 
    mutate(var_gbm = rownames(.)) %>% 
    arrange(desc(Overall)) %>% 
    rename("Imp_gbm" = "Overall")
)
```

## Log Ratio 1

```{r}
# Log Ratio 1
rangerM <- readRDS("../data/models/03_rangerModel_log_R2_11_all.rds")
xgbM <- readRDS("../data/models/03_xgbModel_all_log_R2_11_TLCUSTOM.rds")
gbmM <- readRDS("../data/models/03_gbmModel_log_R2_11_all.rds")


rangerM$bestTune
rangerM$finalModel$r.squared
plot(rangerM) 
plot(xgbM)
xgbM

xgbM$finalModel
plot(gbmM)


cbind(
  varImp(rangerM)$importance %>% 
    round(2) %>% 
    mutate(var_ranger = rownames(.)) %>% 
    arrange(desc(Overall)) %>% 
    rename("Imp_ranger" = "Overall"),
  summary.gbm(gbmM$finalModel, plotit=FALSE) %>% 
    mutate_if(is.numeric, round, 2) %>% 
    mutate(var_gbm = rownames(.)) %>% 
    arrange(desc(rel.inf)) %>% 
    rename("Imp_gbm" = "rel.inf"),
  varImp(xgbM)$importance %>% 
    round(2) %>% 
    mutate(var_gbm = rownames(.)) %>% 
    arrange(desc(Overall)) %>% 
    rename("Imp_gbm" = "Overall")
)
```

## Log Ratio 2

```{r}
# Log Ratio 2
rangerM <- readRDS("../data/models/03_rangerModel_log_R2_12_all.rds")
xgbM <- readRDS("../data/models/03_xgbModel_all_log_R2_12_TLCUSTOM.rds")
gbmM <- readRDS("../data/models/03_gbmModel_log_R2_12_all.rds")


rangerM$bestTune
rangerM$finalModel$r.squared
plot(rangerM) 
plot(xgbM)
xgbM

xgbM$finalModel
plot(gbmM)


cbind(
  varImp(rangerM)$importance %>% 
    round(2) %>% 
    mutate(var_ranger = rownames(.)) %>% 
    arrange(desc(Overall)) %>% 
    rename("Imp_ranger" = "Overall"),
  summary.gbm(gbmM$finalModel, plotit=FALSE) %>% 
    mutate_if(is.numeric, round, 2) %>% 
    mutate(var_gbm = rownames(.)) %>% 
    arrange(desc(rel.inf)) %>% 
    rename("Imp_gbm" = "rel.inf"),
  varImp(xgbM)$importance %>% 
    round(2) %>% 
    mutate(var_gbm = rownames(.)) %>% 
    arrange(desc(Overall)) %>% 
    rename("Imp_gbm" = "Overall")
)
```
:::

```         
```
